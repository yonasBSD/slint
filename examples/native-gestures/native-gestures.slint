// Copyright © SixtyFPS GmbH <info@slint.dev>
// SPDX-License-Identifier: MIT

import { Switch } from "std-widgets.slint";

enum Orientation {
    portrait,
    landscape,
}

component InfoItem inherits VerticalLayout {
    in property <string> label;
    in property <string> value;
    in property <brush> value-color: #e0e0f0;

    alignment: center;
    spacing: 2px;

    Text {
        text: root.label;
        color: #606080;
        font-size: 11px;
        horizontal-alignment: center;
    }

    Text {
        text: root.value;
        color: root.value-color;
        font-size: 16px;
        font-weight: 700;
        horizontal-alignment: center;
    }
}

component ResetButton inherits Rectangle {
    callback clicked();

    height: 28px;
    width: layout.preferred-width;
    background: ta.has-hover ? #0f3460 : #16213e;
    border-radius: 6px;
    border-width: 1px;
    border-color: #404060;

    ta := TouchArea {
        clicked => {
            root.clicked();
        }
    }

    layout := HorizontalLayout {
        padding-left: 12px;
        padding-right: 12px;

        Text {
            text: "Reset";
            color: #a0a0b0;
            font-size: 13px;
            vertical-alignment: center;
            horizontal-alignment: center;
        }
    }
}

global gestureData {
    in property <Point> content-offset: { x: 0px, y: 0px };
    in property <Point> transform-position: { x: 0px, y: 0px };
    in property <Point> content-position: { x: 0px, y: 0px };
    in property <float> base-scale: 1.0;
    in property <float> current-scale: 1.0;
    in property <angle> base-rotation: 0deg;
    in property <angle> current-rotation: 0deg;
    in property <bool> gesture-active: false;
}

component GestureArea inherits Rectangle {
    in property <bool> gesture-active;

    background: root.gesture-active ? #1e2a4a : #16213e;
    border-radius: 8px;
    border-width: root.gesture-active ? 2px : 0px;
    border-color: #e94560;
    clip: true;

    visible-area := Rectangle {
        transform-holder := Rectangle {
            x: gestureData.transform-position.x;
            y: gestureData.transform-position.y;
            width: 0;
            height: 0;
            transform-rotation: gestureData.current-rotation;
            transform-scale: gestureData.current-scale;

            content-holder := Rectangle {
                x: gestureData.content-position.x;
                y: gestureData.content-position.y;
                width: visible-area.width;
                height: visible-area.height;
                img := Image {
                    width: 200px;
                    height: 200px;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    source: @image-url("../../logo/slint-logo-square-dark.png");
                }
            }
        }
    }

    Timer {
        running: true;
        interval: 1ms;
        triggered => {
            gestureData.content-offset = visible-area.absolute-position;
            self.stop();
        }
    }
}

component InfoPanel inherits VerticalLayout {
    in property <float> current-scale;
    in property <angle> current-rotation;
    in property <string> status-text;
    in property <bool> gesture-active;
    in property <bool> has-gesture-occurred;
    in property <length> center-x;
    in property <length> center-y;

    InfoItem {
        label: "Scale";
        value: round(root.current-scale * 100) + "%";
    }

    InfoItem {
        label: "Rotation";
        value: round(root.current-rotation / 1deg) + "°";
    }

    InfoItem {
        label: "State";
        value: root.status-text;
        value-color: root.gesture-active ? #e94560 : #a0a0b0;
    }

    InfoItem {
        label: "Center";
        value: root.has-gesture-occurred ? round(root.center-x / 1px) + ", " + round(root.center-y / 1px) : "—";
    }
}

export component MainWindow inherits Window {
    title: "Native Gestures Demo";
    preferred-width: 800px;
    preferred-height: 600px;
    background: #1a1a2e;

    property <bool> gesture-active: false;
    property <string> status-text: "idle";
    property <length> center-x;
    property <length> center-y;
    property <bool> has-gesture-occurred: false;
    property <bool> gestures-enabled: true;
    property <Orientation> orientation: root.width > root.height ? landscape : portrait;

    function reset() {
        gestureData.current-scale = 1.0;
        gestureData.current-rotation = 0deg;
        gestureData.base-scale = 1.0;
        gestureData.base-rotation = 0deg;
        gestureData.transform-position = { x: 0px, y: 0px };
        gestureData.content-position = { x: 0px, y: 0px };
        root.status-text = "idle";
        root.has-gesture-occurred = false;
    }

    PinchGestureHandler {
        enabled: root.gestures-enabled;

        started => {
            gestureData.base-scale = gestureData.current-scale;
            gestureData.base-rotation = gestureData.current-rotation;
            root.gesture-active = true;
            root.status-text = "active";

            let previousX = gestureData.transform-position.x;
            let previousY = gestureData.transform-position.y;
            gestureData.transform-position.x = self.center.x - gestureData.content-offset.x;
            gestureData.transform-position.y = self.center.y - gestureData.content-offset.y;

            let deltaX = previousX - gestureData.transform-position.x;
            let deltaY = previousY - gestureData.transform-position.y;
            let inv-scale = 1 / max(0.1, gestureData.current-scale);
            gestureData.content-position.x += inv-scale * (cos(gestureData.current-rotation) * deltaX + sin(gestureData.current-rotation) * deltaY);
            gestureData.content-position.y += inv-scale * (-sin(gestureData.current-rotation) * deltaX + cos(gestureData.current-rotation) * deltaY);
        }

        updated => {
            gestureData.current-scale = max(0.1, gestureData.base-scale * self.scale);
            gestureData.current-rotation = gestureData.base-rotation + self.rotation;
            root.center-x = self.center.x;
            root.center-y = self.center.y;
            root.has-gesture-occurred = true;
        }

        ended => {
            root.gesture-active = false;
            root.status-text = "ended";
        }

        cancelled => {
            gestureData.base-scale = gestureData.current-scale;
            gestureData.base-rotation = gestureData.current-rotation;
            root.gesture-active = false;
            root.status-text = "cancelled";
        }

        smart-magnify => {
            if gestureData.current-scale > 1.5 {
                gestureData.current-scale = 1.0;
                gestureData.current-rotation = 0deg;
            } else {
                gestureData.current-scale = 2.5;
            }
            root.status-text = "smart magnify";
        }
    }

    // Safe-area inset container
    VerticalLayout {
        x: root.safe-area-insets.left;
        y: root.safe-area-insets.top;
        width: root.width - root.safe-area-insets.left - root.safe-area-insets.right;
        height: root.height - root.safe-area-insets.top - root.safe-area-insets.bottom;
        padding: root.orientation == Orientation.landscape ? 12px : 16px;
        spacing: 8px;

        // Header + controls: single row in landscape, stacked in portrait
        if root.orientation == Orientation.landscape: HorizontalLayout {
            spacing: 12px;
            alignment: center;

            Text {
                text: "PinchGestureHandler Demo";
                color: #e0e0f0;
                font-size: 14px;
                font-weight: 700;
                vertical-alignment: center;
            }

            Text {
                text: "Pinch • Rotate • Double-tap";
                color: #606080;
                font-size: 12px;
                vertical-alignment: center;
            }

            Switch {
                text: "Enabled";
                checked <=> root.gestures-enabled;
            }

            ResetButton {
                clicked => {
                    root.reset();
                }
            }
        }

        if root.orientation == Orientation.portrait: Text {
            text: "PinchGestureHandler Demo";
            color: #e0e0f0;
            font-size: 18px;
            font-weight: 700;
            horizontal-alignment: center;
        }

        if root.orientation == Orientation.portrait: Text {
            text: "Pinch to zoom  •  Rotate with two fingers  •  Double-tap to toggle zoom";
            color: #606080;
            font-size: 12px;
            horizontal-alignment: center;
        }

        if root.orientation == Orientation.portrait: HorizontalLayout {
            alignment: center;
            spacing: 20px;

            Switch {
                text: "Enabled";
                checked <=> root.gestures-enabled;
            }

            ResetButton {
                clicked => {
                    root.reset();
                }
            }
        }

        // Gesture area + info panel: side-by-side in landscape, stacked in portrait
        if root.orientation == Orientation.landscape: HorizontalLayout {
            spacing: 8px;

            GestureArea {
                horizontal-stretch: 1;
                gesture-active: root.gesture-active;
            }

            Rectangle {
                width: 100px;
                background: #16213e;
                border-radius: 6px;

                VerticalLayout {
                    alignment: space-around;
                    padding: 8px;

                    InfoPanel {
                        current-scale: gestureData.current-scale;
                        current-rotation: gestureData.current-rotation;
                        status-text: root.status-text;
                        gesture-active: root.gesture-active;
                        has-gesture-occurred: root.has-gesture-occurred;
                        center-x: root.center-x;
                        center-y: root.center-y;
                    }
                }
            }
        }

        if root.orientation == Orientation.portrait: GestureArea {
            vertical-stretch: 1;
            gesture-active: root.gesture-active;
        }

        if root.orientation == Orientation.portrait: Rectangle {
            height: 60px;
            background: #16213e;
            border-radius: 6px;

            HorizontalLayout {
                alignment: space-around;
                padding: 8px;

                InfoPanel {
                    current-scale: gestureData.current-scale;
                    current-rotation: gestureData.current-rotation;
                    status-text: root.status-text;
                    gesture-active: root.gesture-active;
                    has-gesture-occurred: root.has-gesture-occurred;
                    center-x: root.center-x;
                    center-y: root.center-y;
                }
            }
        }
    }
}
